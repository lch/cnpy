# build manifest for sr.ht
image: archlinux
packages:
 - gnupg
 - gcc
 - clang
 - make
 - python
 - python-numpy
sources:
 - https://git.sr.ht/~quf/cnpy
secrets:
 - d32fc40b-86f6-421f-9a90-daef61450045 # builds.sr.ht secret SSH key
 - 72dc0367-f4d6-4f0b-9670-c1bdfc7e5a1b # .ssh/known_hosts
tasks:
 - check-signature-if-on-master-branch: |
    cd cnpy
    gpg --import .builds/signing-keys.asc # Import keys
    gpg --list-keys | grep '^    ' | sed 's/^ *//' | sed 's/$/:6:/' | gpg --import-ownertrust # Set trust to ultimate
    if test $(git rev-parse HEAD) = $(git rev-parse master); then
      git verify-commit HEAD # Every commit on master should be signed
    fi
 - build-examples-with-gcc: |
    cd cnpy/examples
    CC=gcc make
    make clean
 - build-examples-with-clang: |
    cd cnpy/examples
    CC=clang make
    make clean
 - run-misc-tests-gcc: |
    cd cnpy/tests/misc
    CC=gcc make
    make clean
 - run-misc-tests-clang: |
    cd cnpy/tests/misc
    CC=clang make
    make clean
 - build-fuzz-target-gcc: |
    cd cnpy/tests/fuzz
    CC=gcc make
    make clean
 - build-fuzz-target-clang: |
    cd cnpy/tests/fuzz
    CC=clang make
    make clean
 - run-generated-tests-gcc: |
    cd cnpy/tests/generated
    CC=gcc python3 generate_and_run.py
 - run-generated-tests-clang: |
    cd cnpy/tests/generated
    CC=clang python3 generate_and_run.py
 - update-man: |
    git clone man@man.sr.ht:~quf/cnpy man-cnpy
    cd man-cnpy
    cp ../cnpy/readme.md index.md
    git add .
    if test ! -z "$(git status --porcelain)"; then
      git config --local user.name "builds.sr.ht"
      git config --local user.email "none@none.invalid"
      git commit -m "auto-update index.md"
      git push
    fi
